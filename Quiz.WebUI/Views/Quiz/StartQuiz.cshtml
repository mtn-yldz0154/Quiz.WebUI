@{
    Layout = null;
}


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
<link rel="stylesheet" href="~/css/style.css">
<style>
    /* Arka plan resmi eklenmesi */
    body {
        background-image: url('https://t4.ftcdn.net/jpg/03/45/88/07/360_F_345880772_zIT2mkdCzTthplO7xqaGGrMspN0jw0ll.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    /* Kart stili */
    .card {
        background-color: rgba(255, 255, 255, 0.8); /* Şeffaf arka plan */
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn_start {
        margin-bottom: 20px;
    }

    .quiz_box, .score_box {
        width: 100%;
        max-width: 600px;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
</style>


<div id="resultModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span id="closeModal" class="close">&times;</span>
        <h2>Quiz Sonuçları</h2>
        <table id="resultTable">
            <thead>
                <tr>
                    <th>İsim</th>
                    <th>Skor</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>


<div style="display:none"  class="btn_start">
    <button id="btn_start" class="btn btn-warning btn-lg">Quize Başla</button>
</div>

<div class="card quiz_box">
    <header class="card-header">
        <div class="title">Quiz App</div>
        <div class="timer">
            <div class="time_text">Kalan Süre</div>
            <div class="time_second">10</div>
        </div>
        <div class="time_line"></div>
    </header>
    <section class="card-body">
        <div class="question_text"></div>
        <div class="option_list"></div>
    </section>
    <footer class="card-footer">
        <div class="question_index"></div>
        <button id="next_btn" class="next_btn btn btn-primary btn-sm">Sonraki Soru</button>
    </footer>
</div>

<div class="card score_box">
    <div class="icon"><i class="fas fa-crown"></i></div>
    <div class="score_text"></div>
    <div class="buttons">
        <button style="display:none" class="btn btn-primary btn_replay">Tekrar Başlat</button>
        <button id="btn_quit" class="btn btn-primary btn_quit">Testi Bitir</button>
    </div>
</div>

<script>
    var genelToplamCevap = 0;
    var GecenSure = 0;
    let saniye = 0;
    let Sorusuresi = 0;
    let SoruPuani = 0;
  
    window.onload = getQuestions;
    var correctAnswersCount = 0;

 
    function Soru(soruMetni, cevapSecenekleri, dogruCevap,second,puan) {
        this.soruMetni = soruMetni;
        this.cevapSecenekleri = cevapSecenekleri;
        this.dogruCevap = dogruCevap;
        this.second = second;
        this.puan = puan;
    }

    Soru.prototype.cevabiKontrolEt = function (cevap) {
        return cevap === this.dogruCevap
    }

    let sorular = [];

    function getQuestions() {
        fetch('/admin/GetQuestionList', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                var i = 1;
                sorular = data.map(question => {
                    sorular.push(new Soru(i + "-" + question.question, { a: question.option1, b: question.option2, c: question.option3, d: question.option4 }, question.correctOption,question.second,question.puan));
                    i++;
                });
            
                StartQuiz();
            })
            .catch(error => {
                console.error('Error fetching questions:', error);
            });
    }

    document.getElementById("btn_quit").addEventListener("click", function () {
        const name = "@ViewBag.Name";
        const skor = correctAnswersCount;

        fetch('/quiz/FinishQuiz', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ name: name, skor: skor })
        })
            .then(response => {
                if (response.ok) {
                    window.location.href = "/quiz/index";
                } else {
                    alert("Quiz bitirilemedi!");
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
    });

    function UI() {
        this.btn_start = document.querySelector(".btn_start");
        this.btn_next = document.querySelector(".next_btn");
        this.btn_replay = document.querySelector(".btn_replay");
        this.btn_quit = document.querySelector(".btn_quit");
        this.quiz_box = document.querySelector(".quiz_box");
        this.score_box = document.querySelector(".score_box");
        this.option_list = document.querySelector(".option_list");
        this.correctIcon = '<div class="icon"><i class="fas fa-check"></i></div>';
        this.incorrectIcon = '<div class="icon"><i class="fas fa-times"></i></div>';
        this.time_text = document.querySelector(".time_text");
        this.time_second = document.querySelector(".time_second");
        this.time_line = document.querySelector(".time_line");
    }



    UI.prototype.soruGoster = function (soru) {
        
        let question = `<span>${soru.soruMetni}</span>`;
        let options = '';

        for (let cevap in soru.cevapSecenekleri) {
            options += `<div class="option"><span><b>${cevap}</b>: ${soru.cevapSecenekleri[cevap]}</span></div>`;
        }

        document.querySelector(".question_text").innerHTML = question;
        this.option_list.innerHTML = options;

        const option = this.option_list.querySelectorAll(".option");

        for (let opt of option) {
            opt.setAttribute("onclick", "optionSelected(this)")
        }
    };

    UI.prototype.soruSayisiniGoster = function (soruSirasi, toplamSoru) {
        let tag = `<span class="badge bg-warning">${soruSirasi} / ${toplamSoru}</span>`;
        document.querySelector(".quiz_box .question_index").innerHTML = tag;
    };

    UI.prototype.skoruGoster = function (toplamSoru, dogruCevap) {
        let tag = `Toplam ${toplamSoru} sorudan ${dogruCevap} doğru cevap verdiniz.`;
        document.querySelector(".score_box .score_text").innerHTML = tag;
        correctAnswersCount = dogruCevap;
    };

    document.getElementById("next_btn").addEventListener("click", function () {

        const skor = correctAnswersCount;
        const token = "@ViewBag.Token";
        
        let bodyData = {
            token: token,
            skor: quiz.dogruCevapSayisi === 0 ? 0 : (saniye * SoruPuani) / Sorusuresi
        };

        fetch('/quiz/UpdateQuiz', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(bodyData)
           
        })
            .then(response => {
                if (response.ok) {
                    return response.json();  // JSON formatında çözümle
                } else {
                    throw new Error("Quiz güncellenemedi!");
                }
            })
            .then(contestantList => {
                quiz.dogruCevapSayisi = 0;

                // Modal'ı göster
                const modal = document.getElementById('resultModal');
                modal.style.display = "block";

                // Yarışmacı listesini tabloya ekleyin
                const tableBody = document.querySelector('#resultTable tbody');
                tableBody.innerHTML = '';  // Eski sonuçları temizleyin
                contestantList.forEach(contestant => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${contestant.name}</td><td>${contestant.skor}</td>`;
                    tableBody.appendChild(row);
                });

                // 10 saniye sonra modalı kapatın ve diğer soruya geçin
                setTimeout(() => {
                    modal.style.display = "none";  // Modalı kapat
                    document.querySelector(".time_text").textContent = "Kalan Süre";
                    if (quiz.sorular.length != quiz.soruIndex + 1) {
                        SoruPuani = quiz.soruGetir().puan;
                        quiz.soruIndex += 1;
                        clearInterval(counter);
                        clearInterval(counterLine);
                        startTimer(quiz.soruGetir().second)
                        startTimerLine();
                        ui.soruGoster(quiz.soruGetir());
                        ui.soruSayisiniGoster(quiz.soruIndex + 1, quiz.sorular.length);
                        ui.btn_next.classList.remove("show");
                    } else {
                        clearInterval(counter);
                        clearInterval(counterLine);
                        ui.quiz_box.classList.remove("active");
                        ui.score_box.classList.add("active");
                        ui.skoruGoster(quiz.sorular.length, quiz.dogruCevapSayisi);
                    }
                }, 5000);
            })
            .catch(error => {
                console.error("Error:", error);
            });
        
    });


   function StartQuiz(){
        document.getElementById("btn_start").click()

   }
    
</script>

<script src="~/js/quiz.js"></script>
<script src="~/js/script.js"></script>

